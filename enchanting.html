<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f0f12">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="full-screen" content="yes">
    <title id="page-title">AION 8.x - Enchanting Simulator</title>
    <link rel="shortcut icon" href="https://assets.playnccdn.com/common/aion.ico" type="image/x-icon">
    <link rel="icon" href="https://assets.playnccdn.com/common/aion.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="https://assets.playnccdn.com/common/aion.ico">
    <link rel="stylesheet" href="assets/css/aion-tools.css">
</head>
<body class="page-calculator">
    <a href="aion.html" class="home-button">üè† Tools Hub</a>

    <div class="container">
        <h1>AION Enchanting Simulator</h1>

        <!-- Tab Navigation -->
        <div class="tabs-container">
            <button class="tab-btn" onclick="switchTab('ultimate')"><img src="https://aioncodex.com/items/icon_item_equip_pl_torso_f01.png" alt="Armor" class="tab-label-icon"> Ultimate Gear</button>
            <button class="tab-btn" onclick="switchTab('extreme')"><img src="https://aioncodex.com/items/icon_item_equip_pl_torso_f01.png" alt="Armor" class="tab-label-icon"> Extreme Gear</button>
            <button class="tab-btn rune-odian-tab" onclick="switchTab('rune')">
                <img src="https://aioncodex.com/items/icon_item_equip_rune_att_01.png" alt="Rune" class="tab-icon">
                <img src="https://aioncodex.com/items/icon_item_equip_rune_def_01.png" alt="Rune" class="tab-icon">
                <img src="https://aioncodex.com/items/icon_item_equip_rune_alw_01.png" alt="Rune" class="tab-icon">
                <img src="https://aioncodex.com/items/icon_item_equip_odian_red_03.png" alt="Odian" class="tab-icon">
                <img src="https://aioncodex.com/items/icon_item_equip_odian_blue_03.png" alt="Odian" class="tab-icon">
                <img src="https://aioncodex.com/items/icon_item_equip_odian_green_03.png" alt="Odian" class="tab-icon">
            </button>
        </div>

        <!-- EXTREME GEAR TAB -->
        <div id="extreme" class="tab-content active">
            <div class="simulator-panel">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div class="simulator-info">
                        <strong>Extreme Gear Enchanting</strong><br>
                        Simulate a single enchantment attempt from start to end level. Results show total stones, items used, and items destroyed.
                    </div>
                </div>

                <div class="items-display">
                    <div class="items-grid">
                        <div class="item-card">
                            <img src="https://aioncodex.com/items/icon_item_enchant_infinite_n_01.png" alt="Ultimate Extreme Enchantment Stone">
                            <span>Ultimate Extreme Enchantment Stone</span>
                        </div>
                    </div>
                </div>

                <div class="settings-grid">
                    <div class="setting-group">
                        <label for="extreme-start">üìç Start Level</label>
                        <select id="extreme-start" onchange="updateExtremeEnd()">
                            <option value="5" selected>Level 5</option>
                            <option value="6">Level 6</option>
                            <option value="7">Level 7</option>
                            <option value="8">Level 8</option>
                            <option value="9">Level 9</option>
                            <option value="10">Level 10</option>
                            <option value="11">Level 11</option>
                            <option value="12">Level 12</option>
                            <option value="13">Level 13</option>
                            <option value="14">Level 14</option>
                        </select>
                    </div>

                    <div class="setting-group">
                        <label for="extreme-end">üèÅ End Level</label>
                        <select id="extreme-end" onchange="saveExtremeEnd()">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button class="sim-button" onclick="runExtremeSimulation()">‚ñ∂Ô∏è Run Simulation</button>
                    <button class="clear-button" onclick="clearExtremeOutput()">Clear Output</button>
                    <button class="info-button" onclick="toggleRates('extreme')" title="Show success and destruction rates">‚ÑπÔ∏è Rates</button>
                </div>

                <div class="enchant-loading-bar" id="extreme-loading"></div>

                <div class="output-container" id="extreme-output">
                    <div class="output-line header">Output will appear here...</div>
                </div>
            </div>
        </div>

        <!-- RUNE/ODIAN TAB -->
        <div id="rune" class="tab-content">
            <div class="simulator-panel">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div class="simulator-info">
                        <strong>Rune/Odian Enchanting</strong><br>
                        Enchanting with risk of contamination requiring purifiers. After reaching the maximum number of contaminations, the item is wasted and resets to level 0.
                    </div>
                </div>

                <div class="items-display">
                    <div class="items-grid">
                        <div class="item-card">
                            <img src="https://aioncodex.com/items/icon_item_enchant_grind_item_01.png" alt="Ancient Polishing Stone">
                            <span>Ancient Polishing Stone</span>
                        </div>
                        <div class="item-card">
                            <img src="https://aioncodex.com/items/icon_item_enchant_purifier_01.png" alt="Ancient Purifier">
                            <span>Ancient Purifier</span>
                        </div>
                    </div>
                </div>

                <div class="settings-grid">
                    <div class="setting-group">
                        <label for="rune-start">üìç Start Level</label>
                        <select id="rune-start" onchange="updateRuneEnd()">
                            <option value="0" selected>Level 0</option>
                            <option value="1">Level 1</option>
                            <option value="2">Level 2</option>
                            <option value="3">Level 3</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                            <option value="6">Level 6</option>
                            <option value="7">Level 7</option>
                            <option value="8">Level 8</option>
                            <option value="9">Level 9</option>
                            <option value="10">Level 10</option>
                            <option value="11">Level 11</option>
                            <option value="12">Level 12</option>
                            <option value="13">Level 13</option>
                            <option value="14">Level 14</option>
                        </select>
                    </div>

                    <div class="setting-group">
                        <label for="rune-end">üèÅ End Level</label>
                        <select id="rune-end" onchange="saveRuneEnd()">
                            <!-- Populated dynamically -->
                        </select>
                    </div>

                    <div class="setting-group">
                        <label for="rune-contamination">‚ò¢Ô∏è Maximum contaminations</label>
                        <select id="rune-contamination">
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button class="sim-button" onclick="runRuneSimulation()">‚ñ∂Ô∏è Run Simulation</button>
                    <button class="clear-button" onclick="clearRuneOutput()">Clear Output</button>
                    <button class="info-button" onclick="toggleRates('rune')" title="Show contamination and failure rates">‚ÑπÔ∏è Rates</button>
                </div>

                <div class="enchant-loading-bar" id="rune-loading"></div>

                <div class="output-container" id="rune-output">
                    <div class="output-line header">Output will appear here...</div>
                </div>
            </div>
        </div>

        <!-- ULTIMATE GEAR TAB -->
        <div id="ultimate" class="tab-content">
            <div class="simulator-panel">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div class="simulator-info">
                        <strong>Ultimate Gear Enchanting</strong><br>
                        Interactive single-attempt enchanting. Select a stone and click Enchant for each attempt. Success rates and critical chance displayed above.
                    </div>
                </div>

                <div class="ultimate-chance-box">
                    <div class="chance-header">Chance</div>
                    <div class="level-transition">
                        <span id="current-level-display">0</span>
                        <span class="arrow">‚Üí</span>
                        <span id="next-level-display">1</span>
                    </div>
                    <div class="chance-percentage">
                        Enchantment success chance: <span id="success-chance-display">100</span>%
                    </div>
                    <div class="critical-info">
                        Critical probability for +2: 10%
                    </div>
                </div>

                <div class="button-group">
                    <button class="sim-button" onclick="runUltimateEnchant()">Enchant</button>
                    <button class="clear-button" onclick="resetUltimateGear()">Reset</button>
                    <button class="info-button" onclick="toggleRates('ultimate')" title="Show success rates by stone type">‚ÑπÔ∏è Rates</button>
                </div>

                <div class="enchant-loading-bar" id="enchant-loading"></div>

                <div class="ultimate-gear-attempts">
                    <div style="display: flex; gap: 20px; align-items: center; margin-top: 10px; font-size: 20px;">Stones Used:
                        <div class="item-card stone-button" id="stone-ancient" style="display: flex; align-items: center; gap: 8px; cursor: pointer;" onclick="selectUltimateStone('ancient')">
                            <img src="https://aioncodex.com/items/icon_item_enchant_pve_a01.png" alt="Ancient" style="width: 30px; height: 30px;">
                        </div>
                        <span id="ancient-counter" style="font-size: 20px;">0</span>
                        <div class="item-card stone-button" id="stone-legendary" style="display: flex; align-items: center; gap: 8px; cursor: pointer;" onclick="selectUltimateStone('legendary')">
                            <img src="https://aioncodex.com/items/icon_item_enchant_pve_r01.png" alt="Legendary" style="width: 30px; height: 30px;">
                        </div>
                        <span id="legendary-counter" style="font-size: 20px;">0</span>
                        <div class="item-card stone-button" id="stone-ultimate" style="display: flex; align-items: center; gap: 8px; cursor: pointer;" onclick="selectUltimateStone('ultimate')">
                            <img src="https://aioncodex.com/items/icon_item_enchant_pve_f01.png" alt="Ultimate" style="width: 30px; height: 30px;">
                        </div>
                        <span id="ultimate-counter" style="font-size: 20px;">0</span>
                    </div>
                </div>

                <div class="output-container" id="ultimate-output">
                    <div class="output-line header">Select a stone and click Enchant to begin...</div>
                </div>
            </div>
        </div>

        <!-- Rate Modals -->
        <div id="extreme-rates-modal" class="rates-modal" onclick="if(event.target === this) this.style.display='none'">
            <div class="rates-modal-content" style="max-width: 600px; border: 1px solid #444; background: #1a1a24;">
                <span class="close" onclick="toggleRates('extreme')">&times;</span><br>
                
                <h3 style="color: #ff4d4d; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;">
                    Extreme Gear Enchantment Rates
                </h3>

                <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 0.95em;">
                    <thead>
                        <tr style="border-bottom: 2px solid #333; color: #aaa;">
                            <th style="padding: 10px;">Level</th>
                            <th style="padding: 10px; color: #4dfb4d;">Success</th>
                            <th style="padding: 10px; color: #ff3333;">Destroy</th>
                            <th style="padding: 10px;">Fail (Safe)</th>
                        </tr>
                    </thead>
                    <tbody style="font-weight: bold;">
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>1</td><td>45%</td><td style="color: #ff3333;">9,1%</td><td style="color: #888;">55%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35; background: rgba(255,255,255,0.02);"><td>2</td><td>42%</td><td style="color: #ff3333;">13,8%</td><td style="color: #888;">58%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>3</td><td>19,5%</td><td style="color: #ff3333;">6,8%</td><td style="color: #888;">80,5%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35; background: rgba(255,255,255,0.02);"><td>4</td><td>17,5%</td><td style="color: #ff3333;">9,1%</td><td style="color: #888;">82,5%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>5</td><td>10,7%</td><td style="color: #ff3333;">7,1%</td><td style="color: #888;">89,3%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35; background: rgba(255,255,255,0.02);"><td>6</td><td>9,3%</td><td style="color: #ff3333;">8,5%</td><td style="color: #888;">90,7%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>7</td><td>5,6%</td><td style="color: #ff3333;">6,8%</td><td style="color: #888;">94,4%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35; background: rgba(255,255,255,0.02);"><td>8</td><td>4,3%</td><td style="color: #ff3333;">8,0%</td><td style="color: #888;">95,7%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>9</td><td>2,6%</td><td style="color: #ff3333;">7,6%</td><td style="color: #888;">97,4%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35; background: rgba(255,255,255,0.02);"><td>10</td><td>1,5%</td><td style="color: #ff3333;">8,6%</td><td style="color: #888;">98,5%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35; background: rgba(255,77,77,0.05);"><td>11-15</td><td>0,4%</td><td style="color: #ff3333;">9,6%</td><td style="color: #888;">99,6%</td></tr>
                    </tbody>
                </table>
                <div style="margin-top: 15px; font-size: 0.85em; color: #888; text-align: left; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                    <strong>Note:</strong> Failure to reach success or destroy threshold results in a simple <strong>Fail</strong> (item is kept, stone is lost).
                </div>
            </div>
        </div>

        <div id="rune-rates-modal" class="rates-modal" onclick="if(event.target === this) this.style.display='none'">
            <div class="rates-modal-content" style="max-width: 600px; border: 1px solid #444; background: #1a1a24;">
                <span class="close" onclick="toggleRates('rune')">&times;</span><br>
                
                <h3 style="color: #b565f5; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;">
                    Rune & Odian Enchantment Rates
                </h3>

                <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 0.95em;">
                    <thead>
                        <tr style="border-bottom: 2px solid #333; color: #aaa;">
                            <th style="padding: 10px;">Level</th>
                            <th style="padding: 10px; color: #ffa500;">Contamination</th>
                            <th style="padding: 10px; color: #ff4d4d;">Fail</th>
                            <th style="padding: 10px; color: #4dfb4d;">Success</th>
                        </tr>
                    </thead>
                    <tbody style="font-weight: bold;">
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>0</td><td>0%</td><td>0%</td><td style="color: #4dfb4d;">100%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>1</td><td>0%</td><td style="color: #888;">20%</td><td style="color: #4dfb4d;">80%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>2</td><td>0%</td><td style="color: #888;">20%</td><td style="color: #4dfb4d;">80%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>3</td><td>0%</td><td style="color: #888;">20%</td><td style="color: #4dfb4d;">80%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>4</td><td style="color: #ffa500;">10%</td><td style="color: #ff4d4d;">50%</td><td>40%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>5-9</td><td style="color: #ffa500;">10%</td><td style="color: #ff4d4d;">57%</td><td>33%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>10</td><td style="color: #ffa500;">10%</td><td style="color: #ff4d4d;">90%</td><td>10%</td></tr>
                        <tr style="border-bottom: 1px solid #2a2a35;"><td>11+</td><td style="color: #ffa500;">10%</td><td style="color: #ff4d4d;">99%</td><td>1%</td></tr>
                    </tbody>
                </table>
                <div style="margin-top: 15px; font-size: 0.85em; color: #888; text-align: left; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                    <p style="margin: 0;"><strong>‚ò£Ô∏è Contamination:</strong> Item breaks and resets to 0 if "Cleans" are exhausted.</p>
                </div>
            </div>
        </div>

        <div id="ultimate-rates-modal" class="rates-modal" onclick="if(event.target === this) this.style.display='none'">
            <div class="rates-modal-content" style="max-width: 90%; border: 1px solid #444; background: #1a1a24;">
                <span class="close" onclick="toggleRates('ultimate')">&times;</span><br>
                
                <h3 style="color: #4da3ff; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;">
                    Ultimate Gear Enchantment Rates
                </h3>

                <table class="rates-table" style="width: 100%; border-collapse: collapse; text-align: center;">
                    <thead>
                        <tr style="border-bottom: 2px solid #333;">
                            <th style="padding: 10px; color: #aaa;">Level</th>
                            <th style="padding: 10px;"><img src="https://aioncodex.com/items/icon_item_enchant_pve_a01.png" width="24"><br><small style="color: #cd7f32;">Ancient</small></th>
                            <th style="padding: 10px;"><img src="https://aioncodex.com/items/icon_item_enchant_pve_r01.png" width="24"><br><small style="color: #a335ee;">Legendary</small></th>
                            <th style="padding: 10px;"><img src="https://aioncodex.com/items/icon_item_enchant_pve_f01.png" width="24"><br><small style="color: #ff4d4d;">Ultimate</small></th>
                        </tr>
                    </thead>
                    <tbody style="font-weight: bold;">
                        <tr style="border-bottom: 1px solid #2a2a35;">
                            <td style="padding: 12px; color: #888;">1 - 3</td>
                            <td style="color: #fff;">52%</td>
                            <td style="color: #4dfb4d;">100%</td>
                            <td style="color: #4dfb4d;">100%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #2a2a35; background: rgba(255,255,255,0.02);">
                            <td style="padding: 12px; color: #888;">4 - 6</td>
                            <td style="color: #fff;">32%</td>
                            <td style="color: #fff;">82%</td>
                            <td style="color: #fff;">92%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #2a2a35;">
                            <td style="padding: 12px; color: #888;">7 - 9</td>
                            <td style="color: #fff;">12%</td>
                            <td style="color: #fff;">62%</td>
                            <td style="color: #fff;">72%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #2a2a35; background: rgba(255,255,255,0.02);">
                            <td style="padding: 12px; color: #888;">10 - 15</td>
                            <td style="color: #fff;">5%</td>
                            <td style="color: #fff;">42%</td>
                            <td style="color: #fff;">52%</td>
                        </tr>
                    </tbody>
                </table>

                <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.85em; text-align: left;">
                    <p style="margin: 0 0 8px 0;"><strong style="color: #ffd700;">‚ú® Critical:</strong> 10% chance for +2 on success</p>
                    <p style="margin: 0; line-height: 1.4;">
                        <strong style="color: #ff4d4d;">‚ö†Ô∏è Penalty:</strong> 
                        <img src="https://aioncodex.com/items/icon_item_enchant_pve_a01.png" width="14"> / 
                        <img src="https://aioncodex.com/items/icon_item_enchant_pve_r01.png" width="14"> : -1 or reset to +10. <br>
                        <span style="margin-left: 65px;"><img src="https://aioncodex.com/items/icon_item_enchant_pve_f01.png" width="14"> : No penalty.</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-actions">
                <a href="https://discordapp.com/users/158658357606088704" target="_blank" class="discord-button">
                    <svg class="discord-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                    Support & Feedback
                </a>
            </div>

            <div class="copyright">
                ¬© <span id="copyright-year"></span> <a href="myAionProfiles.html"><strong>15TAN</strong></a> - AION Tools Hub<br>
                Tools and calculators for AION Retail 8.x
            </div>

            <div class="disclaimer">
                This website is a non-commercial fan project. AION and all related images/assets are trademarks or registered trademarks of NCSoft Corporation and Gameforge. All rights reserved.
            </div>
        </div>
    </div>

    <script>
        // Extreme Gear Enchanting Data
        const EXTREME_SUCCESS = [450, 420, 195, 175, 107, 93, 56, 43, 26, 15, 4, 4, 4, 4, 4];
        const EXTREME_DESTROY = [91, 138, 68, 91, 71, 85, 68, 80, 76, 86, 96, 96, 96, 96, 96];
        const EXTREME_MIN_LEVEL = 5;
        const EXTREME_MAX_LEVEL = 15;

        // Rune/Odian Enchanting Data
        const RUNE_FAIL = [0, 20, 20, 20, 50, 57, 57, 57, 57, 57, 90, 99, 99, 99, 99];
        const RUNE_CONTAMINATION = [0, 0, 0, 0, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10];

        // Ultimate Gear Enchanting Data
        const ULTIMATE_ANCIENT = [0, 52, 52, 52, 32, 32, 32, 12, 12, 12, 5, 5, 5, 5, 5, 5];
        const ULTIMATE_LEGENDARY = [0, 100, 100, 100, 82, 82, 82, 62, 62, 62, 42, 42, 42, 42, 42, 42];
        const ULTIMATE_ULTIMATE = [0, 100, 100, 100, 92, 92, 92, 72, 72, 72, 52, 52, 52, 52, 52, 52];
        const ULTIMATE_CRITICAL = 10;
        const ULTIMATE_MAX_LEVEL = 15;
        let selectedUltimateStone = localStorage.getItem('ultimateStone') || 'ultimate';
        let currentUltimateLevel = parseInt(localStorage.getItem('ultimateLevel')) || 0;
        let ultimateAncientUsed = parseInt(localStorage.getItem('ultimateAncientUsed')) || 0;
        let ultimateLegendaryUsed = parseInt(localStorage.getItem('ultimateLegendaryUsed')) || 0;
        let ultimateUltimateUsed = parseInt(localStorage.getItem('ultimateUltimateUsed')) || 0;

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');

            // Mark button as active and save to localStorage
            event.target.classList.add('active');
            localStorage.setItem('activeTab', tabName);
        }

        // Update end level based on start level
        function updateExtremeEnd() {
            const startLevel = parseInt(document.getElementById('extreme-start').value);
            // persist start level selection
            try { localStorage.setItem('extremeStart', startLevel); } catch(e){}
            const endSelect = document.getElementById('extreme-end');
            const currentEnd = parseInt(endSelect.value) || startLevel + 1;
            
            // Clear current options
            endSelect.innerHTML = '';

            // Add options from startLevel + 1 to EXTREME_MAX_LEVEL
            for (let i = startLevel + 1; i <= EXTREME_MAX_LEVEL; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Level ${i}`;
                // Select the first option or keep previous selection if valid
                if (i === startLevel + 1 || i === currentEnd) {
                    option.selected = true;
                }
                endSelect.appendChild(option);
            }
            // If we have a saved end level, try to restore it
            try {
                const savedEnd = parseInt(localStorage.getItem('extremeEnd'));
                if (savedEnd && savedEnd > startLevel && savedEnd <= EXTREME_MAX_LEVEL) {
                    endSelect.value = savedEnd;
                }
            } catch(e) {}
        }

        // Save extreme end selection when user changes it
        function saveExtremeEnd() {
            const endSelect = document.getElementById('extreme-end');
            if (!endSelect) return;
            try { localStorage.setItem('extremeEnd', endSelect.value); } catch(e){}
        }

        // Update end level based on start level (Rune)
        function updateRuneEnd() {
            const startLevel = parseInt(document.getElementById('rune-start').value);
            // persist start level selection
            try { localStorage.setItem('runeStart', startLevel); } catch(e){}
            const endSelect = document.getElementById('rune-end');
            const currentEnd = parseInt(endSelect.value) || startLevel + 1;
            
            // Clear current options
            endSelect.innerHTML = '';

            // Add options from startLevel + 1 to 15
            for (let i = startLevel + 1; i <= 15; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Level ${i}`;
                // Select the first option or keep previous selection if valid
                if (i === startLevel + 1 || i === currentEnd) {
                    option.selected = true;
                }
                endSelect.appendChild(option);
            }
            // If we have a saved end level, try to restore it
            try {
                const savedEnd = parseInt(localStorage.getItem('runeEnd'));
                if (savedEnd && savedEnd > startLevel && savedEnd <= 15) {
                    endSelect.value = savedEnd;
                }
            } catch(e) {}
        }

        // Save rune end selection when user changes it
        function saveRuneEnd() {
            const endSelect = document.getElementById('rune-end');
            if (!endSelect) return;
            try { localStorage.setItem('runeEnd', endSelect.value); } catch(e){}
        }

            // Run Extreme Gear Simulation (with loading animation)
            function runExtremeSimulation() {
                const startLevel = parseInt(document.getElementById('extreme-start').value);
                const endLevel = parseInt(document.getElementById('extreme-end').value);

                const panel = document.getElementById('extreme');
                const output = document.getElementById('extreme-output');

                const simBtn = panel.querySelector('button.sim-button');
                const clearBtn = panel.querySelector('button.clear-button');
                const loadingBar = document.getElementById('extreme-loading');

                if (simBtn) simBtn.disabled = true;
                if (clearBtn) clearBtn.disabled = true;
                if (loadingBar) loadingBar.classList.add('active');

                setTimeout(() => {
                    // Run single simulation
                    const result = simulateExtremeEnchanting(startLevel, endLevel);

                    // persist last-used start/end
                    try { localStorage.setItem('extremeStart', startLevel); localStorage.setItem('extremeEnd', endLevel); } catch(e){}

                    // Display latest-only summary (replace previous output)
                    output.innerHTML = `<div class="output-line summary extreme-summary">
                        <strong>ENCHANTMENT COMPLETE</strong>
                        <div style="margin-top:8px">Target: <strong>Level ${endLevel}</strong></div>
                        <div style="margin-top:8px">üìä FINAL RESULTS</div>
                        <div style="margin-top:6px"><strong>‚úì Total Enchantment Stones Used:</strong> ${result.totalStones}</div>
                        <div><strong>‚úì Items Used:</strong> ${result.itemsUsed}</div>
                        <div><strong>‚úó Items Destroyed:</strong> ${result.itemsDestroyed}</div>
                        <div><strong>‚óà Stones for Last Item:</strong> ${result.lastItemStones}</div>
                    </div>`;

                    if (loadingBar) loadingBar.classList.remove('active');
                    if (simBtn) simBtn.disabled = false;
                    if (clearBtn) clearBtn.disabled = false;
                }, 250);
            }

        // Single Extreme Enchanting Simulation (Version 2 logic)
        function simulateExtremeEnchanting(startLevel, endLevel) {
            let enchantLevel = startLevel;
            let itemsWasted = 0;
            let totalStones = 0;
            let lastItemStones = 0;
            let details = [];

            while (enchantLevel < endLevel) {
                totalStones++;
                lastItemStones++;

                const levelIndex = enchantLevel - 5;
                const random = Math.floor(Math.random() * 1000);
                
                const successChance = EXTREME_SUCCESS[levelIndex];
                const destroyChance = EXTREME_DESTROY[levelIndex];

                // 1. Check for Success first
                if (random < successChance) {
                    enchantLevel++;
                    details.push({
                        type: 'success',
                        message: `Roll: ${random} ‚Äî Success! Level: ${enchantLevel}`
                    });
                } 
                // 2. If not success, check if it falls within the Destroy range
                // We check if the roll is between the Success threshold and the Destroy threshold
                else if (random < (successChance + destroyChance)) {
                    enchantLevel = startLevel;
                    lastItemStones = 0;
                    itemsWasted++;
                    details.push({
                        type: 'destroy',
                        message: `Roll: ${random} ‚Äî CRITICAL FAILURE: Item Destroyed! Total wasted: ${itemsWasted}`
                    });
                } 
                // 3. If it's outside both ranges, it's a simple fail (Stone lost, no level change)
                else {
                    details.push({
                        type: 'fail',
                        message: `Roll: ${random} ‚Äî Failed. No change. Level: ${enchantLevel}`
                    });
                }
            }

            return {
                totalStones: totalStones,
                itemsWasted: itemsWasted,
                itemsDestroyed: itemsWasted,
                itemsUsed: 1 + itemsWasted,
                lastItemStones: lastItemStones,
                details: details
            };
        }

        // Append to output container
        function appendExtremeOutput(html) {
            const output = document.getElementById('extreme-output');
            const line = document.createElement('div');
            line.innerHTML = html;
            output.appendChild(line);
        }

        // Clear output
        function clearExtremeOutput() {
            const output = document.getElementById('extreme-output');
            output.innerHTML = '<div class="output-line header">Output cleared. Run a simulation to see results.</div>';
        }

        // Run Rune/Odian Simulation (with loading animation)
        function runRuneSimulation() {
            const startLevel = parseInt(document.getElementById('rune-start').value);
            const endLevel = parseInt(document.getElementById('rune-end').value);
            const maxContamination = parseInt(document.getElementById('rune-contamination').value);

            const panel = document.getElementById('rune');
            const output = document.getElementById('rune-output');

            const simBtn = panel.querySelector('button.sim-button');
            const clearBtn = panel.querySelector('button.clear-button');
            const loadingBar = document.getElementById('rune-loading');

            if (simBtn) simBtn.disabled = true;
            if (clearBtn) clearBtn.disabled = true;
            if (loadingBar) loadingBar.classList.add('active');

            setTimeout(() => {
                // Run single simulation
                const result = simulateRuneEnchanting(startLevel, endLevel, maxContamination);

                // persist last-used start/end
                try { localStorage.setItem('runeStart', startLevel); localStorage.setItem('runeEnd', endLevel); } catch(e){}

                // Display latest-only summary (replace previous output)
                output.innerHTML = `<div class="output-line summary rune-summary">
                    <strong>ENCHANTMENT COMPLETE</strong>
                    <div style="margin-top:8px">Target: <strong>Level ${endLevel}</strong></div>
                    <div style="margin-top:8px">üìä FINAL RESULTS</div>
                    <div style="margin-top:6px"><strong>‚úì Total Polishing Stones Used:</strong> ${result.totalPolishings}</div>
                    <div><strong>‚úì Polishings for Last Item:</strong> ${result.lastItemPolishings}</div>
                    <div><strong>‚úó Items Wasted:</strong> ${result.itemsWasted}</div>
                    <div style="margin-top:8px">üßπ CONTAMINATION DETAILS</div>
                    <div><strong>Total Cleans:</strong> ${result.totalCleans}</div>
                    <div><strong>Total Purifiers Used:</strong> ${result.totalPurifiers}</div>
                    <div><strong>Purifiers for Current Item:</strong> ${result.currentItemPurifiers}</div>
                </div>`;

                if (loadingBar) loadingBar.classList.remove('active');
                if (simBtn) simBtn.disabled = false;
                if (clearBtn) clearBtn.disabled = false;
            }, 320);
        }

        // Single Rune/Odian Enchanting Simulation
        function simulateRuneEnchanting(startLevel, endLevel, maxContamination) {
            let enchantLevel = startLevel;
            let polishings = 0;
            let lastItemPolishings = 0;
            let cleans = 0;
            let itemsWasted = 0;
            let totalCleans = 0;
            let totalPurifiers = 0;
            let currentItemPurifiers = 0;

            while (enchantLevel < endLevel) {
                polishings++;
                lastItemPolishings++;

                // Random number 0-99 (represents 100 possible outcomes)
                const random = Math.floor(Math.random() * 100);
                const contaminationThreshold = RUNE_CONTAMINATION[enchantLevel];
                const failThreshold = RUNE_FAIL[enchantLevel];

                if (random <= contaminationThreshold && contaminationThreshold > 0) {
                    // Contamination
                    cleans++;
                    totalCleans++;
                    const purifiersUsed = cleans * enchantLevel;
                    totalPurifiers += purifiersUsed;
                    currentItemPurifiers += purifiersUsed;

                    if (cleans === maxContamination) {
                        // Item wasted
                        enchantLevel = startLevel;
                        cleans = 0;
                        itemsWasted++;
                        currentItemPurifiers = 0;
                        lastItemPolishings = 0;
                    }
                } else if((random > contaminationThreshold) && (random < failThreshold) && (failThreshold > 0)) {
                    // Failed (level decreases)
                    enchantLevel--;
                } else {
                    // Success (level increases)
                    enchantLevel++;
                }
            }

            return {
                totalPolishings: polishings,
                lastItemPolishings: lastItemPolishings,
                itemsWasted: itemsWasted,
                totalCleans: totalCleans,
                totalPurifiers: totalPurifiers,
                currentItemPurifiers: currentItemPurifiers
            };
        }

        // Append to output container
        function appendRuneOutput(html) {
            const output = document.getElementById('rune-output');
            const line = document.createElement('div');
            line.innerHTML = html;
            output.appendChild(line);
        }

        // Clear output
        function clearRuneOutput() {
            const output = document.getElementById('rune-output');
            output.innerHTML = '<div class="output-line header">Output cleared. Run a simulation to see results.</div>';
        }

        // Run Ultimate Gear Enchantment
        function runUltimateEnchant() {
            const targetLevel = currentUltimateLevel + 1;
            
            if (currentUltimateLevel >= ULTIMATE_MAX_LEVEL) {
                alert('Maximum level reached!');
                return;
            }

            // Get button and loading bar
            const enchantBtn = document.querySelector('button[onclick="runUltimateEnchant()"]');
            const loadingBar = document.getElementById('enchant-loading');
            
            // Disable button and show loading animation
            enchantBtn.disabled = true;
            loadingBar.classList.add('active');

            // Perform enchantment after animation completes
            setTimeout(() => {
                // Increment the counter for the selected stone
                if (selectedUltimateStone === 'ancient') {
                    ultimateAncientUsed++;
                    localStorage.setItem('ultimateAncientUsed', ultimateAncientUsed);
                } else if (selectedUltimateStone === 'legendary') {
                    ultimateLegendaryUsed++;
                    localStorage.setItem('ultimateLegendaryUsed', ultimateLegendaryUsed);
                } else {
                    ultimateUltimateUsed++;
                    localStorage.setItem('ultimateUltimateUsed', ultimateUltimateUsed);
                }
                
                // Run enchantment for next level
                const result = performUltimateEnchant(currentUltimateLevel, targetLevel, selectedUltimateStone);
                
                // Update current level
                currentUltimateLevel = result.newLevel;
                
                // Save state to localStorage
                localStorage.setItem('ultimateLevel', currentUltimateLevel);

                // Update UI
                document.getElementById('ancient-counter').textContent = ultimateAncientUsed;
                document.getElementById('legendary-counter').textContent = ultimateLegendaryUsed;
                document.getElementById('ultimate-counter').textContent = ultimateUltimateUsed;
                updateUltimateChanceDisplay();

                // Remove loading animation
                loadingBar.classList.remove('active');

                // Disable button if max level reached
                if (currentUltimateLevel >= ULTIMATE_MAX_LEVEL) {
                    enchantBtn.disabled = true;
                } else {
                    enchantBtn.disabled = false;
                }

                // Display result
                if (result.outcome.includes('Success')) {
                    appendUltimateOutput(`<div class="output-line success">‚úì ${result.outcome}</div>`);
                } else if (result.outcome.includes('CRITICAL')) {
                    appendUltimateOutput(`<div class="output-line success">‚≠ê ${result.outcome}</div>`);
                } else {
                    appendUltimateOutput(`<div class="output-line fail">‚úó ${result.outcome}</div>`);
                }
            }, 250);
        }

        // Select Ultimate Stone
        function selectUltimateStone(stoneType) {
            selectedUltimateStone = stoneType;
            localStorage.setItem('ultimateStone', stoneType);

            // Update active styling for the "Stones Used" section
            document.querySelectorAll('.ultimate-gear-attempts div[onclick]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.ultimate-gear-attempts div[onclick*='${stoneType}']`).classList.add('active');

            // Update chance display
            updateUltimateChanceDisplay();
        }

        // Update chance display
        function updateUltimateChanceDisplay() {
            const levelTransitionElement = document.querySelector('.level-transition');
            
            if (currentUltimateLevel >= ULTIMATE_MAX_LEVEL) {
                // Show only current level at max
                levelTransitionElement.innerHTML = `<span id="current-level-display">${currentUltimateLevel}</span>`;
                document.getElementById('success-chance-display').textContent = '0';
                return;
            }
            
            const nextLevel = currentUltimateLevel + 1;
            let successRates;

            if (selectedUltimateStone === 'ancient') {
                successRates = ULTIMATE_ANCIENT;
            } else if (selectedUltimateStone === 'legendary') {
                successRates = ULTIMATE_LEGENDARY;
            } else {
                successRates = ULTIMATE_ULTIMATE;
            }

            const chance = nextLevel <= ULTIMATE_MAX_LEVEL ? successRates[nextLevel] : 0;
            levelTransitionElement.innerHTML = `<span id="current-level-display">${currentUltimateLevel}</span><span class="arrow">‚Üí</span><span id="next-level-display">${nextLevel}</span>`;
            document.getElementById('success-chance-display').textContent = chance;
        }

        // Perform single Ultimate Enchantment
        function performUltimateEnchant(currentLevel, targetLevel, stoneType) {
            let successRates;

            if (stoneType === 'ancient') {
                successRates = ULTIMATE_ANCIENT;
            } else if (stoneType === 'legendary') {
                successRates = ULTIMATE_LEGENDARY;
            } else {
                successRates = ULTIMATE_ULTIMATE;
            }

            const successRate = successRates[targetLevel];
            const random = Math.floor(Math.random() * 100);
            const criticalRoll = Math.floor(Math.random() * 100);
            const isCritical = criticalRoll < ULTIMATE_CRITICAL;

            let newLevel = currentLevel;
            let outcome = '';

            if (random < successRate) {
                // Success
                if (isCritical) {
                    newLevel = Math.min(targetLevel + 1, ULTIMATE_MAX_LEVEL);
                    outcome = `CRITICAL SUCCESS! Level +${currentLevel} ‚Üí +${newLevel}`;
                } else {
                    newLevel = targetLevel;
                    outcome = `Success! Level +${currentLevel} ‚Üí +${newLevel}`;
                }
            } else {
                // Failure
                if (stoneType === 'ultimate') {
                    // Ultimate stone: nothing happens
                    newLevel = currentLevel;
                    outcome = `Failed - No penalty (Ultimate Stone)`;
                } else {
                    // Ancient/Legendary: -1 if below 10, reset to 10 if at/above 10
                    if (currentLevel >= 10) {
                        newLevel = 10;
                        outcome = `Failed - Reset to +10 (Safe zone)`;
                    } else {
                        newLevel = Math.max(0, currentLevel - 1);
                        outcome = `Failed - Level +${currentLevel} ‚Üí +${newLevel}`;
                    }
                }
            }

            return {
                currentLevel: currentLevel,
                newLevel: newLevel,
                successRate: successRate,
                outcome: outcome
            };
        }

        // Display latest Ultimate output only
        function appendUltimateOutput(html) {
            const output = document.getElementById('ultimate-output');
            output.innerHTML = html;
        }

        // Reset Ultimate Gear
        function resetUltimateGear() {
            currentUltimateLevel = 0;
            ultimateAncientUsed = 0;
            ultimateLegendaryUsed = 0;
            ultimateUltimateUsed = 0;
            
            // Clear localStorage
            localStorage.removeItem('ultimateLevel');
            localStorage.removeItem('ultimateAncientUsed');
            localStorage.removeItem('ultimateLegendaryUsed');
            localStorage.removeItem('ultimateUltimateUsed');
            
            document.getElementById('ancient-counter').textContent = 0;
            document.getElementById('legendary-counter').textContent = 0;
            document.getElementById('ultimate-counter').textContent = 0;
            document.querySelector('.level-transition').innerHTML = `<span id="current-level-display">0</span><span class="arrow">‚Üí</span><span id="next-level-display">1</span>`;
            document.getElementById('ultimate-output').innerHTML = '<div class="output-line header">Gear reset to level 0. Ready for new attempt!</div>';
            document.getElementById('enchant-loading').classList.remove('active');
            
            // Re-enable enchant button
            const enchantBtn = document.querySelector('button[onclick="runUltimateEnchant()"]');
            enchantBtn.disabled = false;
            
            updateUltimateChanceDisplay();
        }

        // Toggle rate display modal
        function toggleRates(tabName) {
            const modal = document.getElementById(tabName + '-rates-modal');
            if (!modal) return;
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('rates-modal')) {
                event.target.style.display = 'none';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('copyright-year').textContent = new Date().getFullYear();
            // Restore saved extreme start if present, then populate end options
            try {
                const savedStart = parseInt(localStorage.getItem('extremeStart'));
                if (!isNaN(savedStart) && document.getElementById('extreme-start')) {
                    document.getElementById('extreme-start').value = savedStart;
                }
            } catch(e) {}
            updateExtremeEnd();
            
            // Restore saved rune start if present, then populate end options
            try {
                const savedStart = parseInt(localStorage.getItem('runeStart'));
                if (!isNaN(savedStart) && document.getElementById('rune-start')) {
                    document.getElementById('rune-start').value = savedStart;
                }
            } catch(e) {}
            updateRuneEnd();
            
            // Restore last active tab
            const savedTab = localStorage.getItem('activeTab') || 'extreme';
            const tabBtn = document.querySelector(`button[onclick="switchTab('${savedTab}')"]`);
            if (tabBtn) {
                // Hide all tabs first
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                // Show saved tab
                document.getElementById(savedTab).classList.add('active');
                tabBtn.classList.add('active');
            }
            
            // Restore Ultimate Gear UI from localStorage
            restoreUltimateGearState();
        });

        // Restore Ultimate Gear session state
        function restoreUltimateGearState() {
            // Update stone counters
            document.getElementById('ancient-counter').textContent = ultimateAncientUsed;
            document.getElementById('legendary-counter').textContent = ultimateLegendaryUsed;
            document.getElementById('ultimate-counter').textContent = ultimateUltimateUsed;
            
            // Update stone selection UI
            document.querySelectorAll('.stone-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('stone-' + selectedUltimateStone).classList.add('active');
            
            // Update level display and chance
            updateUltimateChanceDisplay();
            
            // Disable button if at max level
            if (currentUltimateLevel >= ULTIMATE_MAX_LEVEL) {
                document.querySelector('button[onclick="runUltimateEnchant()"]').disabled = true;
            }
        }

        // --- Extreme session persistence ---
        const EXTREME_SESSION_KEY = 'aion_enchant_extreme_session';

        function saveExtremeSession(state) {
            try {
                localStorage.setItem(EXTREME_SESSION_KEY, JSON.stringify(state));
            } catch (e) {
                console.warn('Failed to save extreme session', e);
            }
        }

        function loadExtremeSession() {
            try {
                const raw = localStorage.getItem(EXTREME_SESSION_KEY);
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                console.warn('Failed to load extreme session', e);
                return null;
            }
        }

        // Call this on page load to restore UI/state
        document.addEventListener('DOMContentLoaded', () => {
            const session = loadExtremeSession();
            if (session) {
                if (typeof session.currentLevel !== 'undefined') {
                    window.extremeCurrentLevel = session.currentLevel;
                    const el = document.getElementById('extreme-current-level');
                    if (el) el.textContent = session.currentLevel;
                }
                if (typeof session.startLevel !== 'undefined') {
                    const s = document.getElementById('extreme-start-level');
                    if (s) s.value = session.startLevel;
                }
                if (typeof session.endLevel !== 'undefined') {
                    const e = document.getElementById('extreme-end-level');
                    if (e) e.value = session.endLevel;
                }
                if (typeof session.itemsWasted !== 'undefined') {
                    const iw = document.getElementById('extreme-items-wasted');
                    if (iw) iw.textContent = session.itemsWasted;
                }
                if (typeof session.totalStones !== 'undefined') {
                    const ts = document.getElementById('extreme-total-stones');
                    if (ts) ts.textContent = session.totalStones;
                }
            }
        });

        // Example helper to be called whenever the extreme enchant level or related state changes.
        function persistExtremeState() {
            const state = {
                currentLevel: window.extremeCurrentLevel ?? null,
                startLevel: document.getElementById('extreme-start-level')?.value ?? null,
                endLevel: document.getElementById('extreme-end-level')?.value ?? null,
                itemsWasted: document.getElementById('extreme-items-wasted')?.textContent ?? 0,
                totalStones: document.getElementById('extreme-total-stones')?.textContent ?? 0
            };
            saveExtremeSession(state);
        }

        // Provide a clear function on reset
        function clearExtremeSession() {
            localStorage.removeItem(EXTREME_SESSION_KEY);
        }
    </script>
</body>
</html>
